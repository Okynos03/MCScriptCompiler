<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>MCScript - Compilador de Bloques</title>
  <link rel="stylesheet" href="/static/style.css">
  <!-- Quill editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

  <script src="/static/js/toggle.js" defer></script>
</head>
<body>
  <!-- PartÃ­culas de decoraciÃ³n -->
  <div class="sparkle"></div>
  <div class="sparkle"></div>
  <div class="sparkle"></div>
  <div class="sparkle"></div>
  
  <div class="header">
    <!-- Logo en la izquierda -->
    <img src="/static/images/logoMCS.png" alt="MCScript Logo" class="logo">
    <!-- Contenedor de tÃ­tulo y subtÃ­tulo centrados -->
    <div class="header-content">
      <h1>ğŸ® MCScript Compiler ğŸ®</h1>
      <p>Construye tu cÃ³digo bloque por bloque</p>
    </div>
  </div>

  <div class="toggle-container">
    <button id="toggleAnalysis" type="button">Mostrar AnÃ¡lisis</button>
  </div>

  <div class="container">
    <!-- Zona izquierda: cuadro editable -->
    <div class="left">
      <div class="block-decoration top-left"></div>
      <div class="block-decoration top-right"></div>
      <div class="block-decoration bottom-left"></div>
      <div class="block-decoration bottom-right"></div>
      
      <div class="panel-title">ğŸ“ Workbench de CÃ³digo</div>
      <form id="codeForm" action="/lex" method="post">
        <!-- Contenedor Quill -->
        <div id="editor"></div>

        <!-- Campo oculto para enviar el cÃ³digo plano -->
        <textarea name="code" id="codeInput" hidden></textarea>

        <div class="button-container">
          <button type="submit">âš¡ Compilar Bloques âš¡</button>
        </div>
      </form>

    </div>

    <!-- Zona derecha: pasa code con el mismo contenido por ahora que se va a cambiar ya con el analisis quij-->
    <div class="right">
      <div class="block-decoration top-left"></div>
      <div class="block-decoration top-right"></div>
      <div class="block-decoration bottom-left"></div>
      <div class="block-decoration bottom-right"></div>
      
      <div class="panel-title">ğŸ” Consola</div>
      <textarea rows="20" readonly placeholder="AquÃ­ aparecerÃ¡n los tokens analizados...">{{ result }}</textarea>
    </div>
  </div>

<script>
  // 1. Carga inicial de Quill
  const quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
      // quita la toolbar si no la necesitas
      toolbar: false,
      keyboard: {
        bindings: {
          // captura TAB para insertar \t
          tab: {
            key: 9,
            handler: function(range) {
              quill.insertText(range.index, '\t');
              quill.setSelection(range.index + 1);
            }
          }
        }
      }
    }
  });

  // 2. Al cargar la pÃ¡gina, mete el cÃ³digo previo
  const initial = `{{ code | replace("\n", "\\n") | replace("\t", "\\t") }}`;
  // Pero Quill.getText() espera saltos reales, asÃ­ que:
  const initialCode = {{ code | tojson }};
  quill.setText(initialCode);
  //quill

  // 3. Form submit â†’ vuelca texto plano limpio
  const form = document.getElementById('codeForm');
  form.addEventListener('submit', () => {
    document.getElementById('codeInput').value = quill.getText();
  });

  // 4. DespuÃ©s del post, justo tras la render del servidor...
  window.addEventListener('DOMContentLoaded', () => {
    // Recupera el array de tokens embebido por Jinja
    const tokens = {{ tokens_json | tojson }};
    // Define colores segÃºn tipo
    const colorMap = {
      1000: '#ab0ed6', // keyword
      2000: '#e36209', // operator
      3000: '#24292e', // punctuation
      4000: '#005cc5', // curly-brace
      5000: '#079c29', // bracket
      6000: '#6f42c1', // identifier
      7000: '#005cc5', // integer
      8000: '#005cc5', // float
    };
    // Aplica formato a cada token
    tokens.forEach(t => {
      const color = colorMap[t.type];
      
      if (color && t.length > 0) {
        quill.formatText(t.index, t.length, { color });
      }
    });
  });

const errors = {{ errors_json | tojson }};
errors.forEach(e => {
  // aplicamos formato underline + color rojo
  quill.formatText(e.index, e.length, {
    underline: true,
    color: '#ff0000'
  });
});
</script>


</body>
</html>
