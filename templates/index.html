<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>MCScript - Compilador de Bloques</title>
  <link rel="stylesheet" href="/static/style.css">
  <!-- Quill editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

  <script src="/static/js/toggle.js" defer></script>
  <script src="/static/js/realTime.js" defer></script>
  <script src="/static/js/darkMode.js" defer></script>
  <script src="/static/js/lineNumbers.js" defer></script>

</head>
<body>
  <!-- Part√≠culas de decoraci√≥n -->
  <div class="sparkle"></div>
  <div class="sparkle"></div>
  <div class="sparkle"></div>
  <div class="sparkle"></div>
  
  <div class="header">
    <img src="/static/images/logoMCS.png" alt="MCScript Logo" class="logo">
    <div class="header-content">
      <h1>üéÆ MCScript Compiler üéÆ</h1>
      <p>Construye tu c√≥digo bloque por bloque</p>
    </div>
  </div>

  <div class="toggle-container">
    <button id="toggleAnalysis" type="button">Mostrar Consola</button>
    <!-- El bot√≥n de modo oscuro se agregar√° aqu√≠ din√°micamente -->
  </div>
  
  <div class="container">
    <div class="left">
      <div class="block-decoration top-left"></div>
      <div class="block-decoration top-right"></div>
      <div class="block-decoration bottom-left"></div>
      <div class="block-decoration bottom-right"></div>
      
      <div class="panel-title">üìù Workbench de C√≥digo</div>
      <form id="codeForm" action="/lex" method="post">
        <!-- Contenedor Quill -->
        <div class="editor-container">
          <div class="line-numbers"></div>
          <div id="editor"></div>
        </div>

        <textarea name="code" id="codeInput" hidden></textarea>

        <div class="button-container">
          <button type="submit">‚ö° Compilar Bloques ‚ö°</button>
        </div>
      </form>

    </div>

    <!-- Zona derecha: pasa code con el mismo contenido por ahora que se va a cambiar ya con el analisis quij-->
    <div class="right">
      <div class="block-decoration top-left"></div>
      <div class="block-decoration top-right"></div>
      <div class="block-decoration bottom-left"></div>
      <div class="block-decoration bottom-right"></div>
      
      <div class="panel-title">üîç Consola</div>
      <textarea rows="20" readonly placeholder="Aqu√≠ aparecer√°n los tokens analizados...">{{ result }}</textarea>
    </div>
  </div>

<script>
  const quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
      toolbar: false,
      keyboard: {
        bindings: {
          // captura TAB para insertar \t
          tab: {
            key: 9,
            handler: function(range) {
              quill.insertText(range.index, '\t');
              quill.setSelection(range.index + 1);
            }
          }
        }
      }
    }
  });

  const initial = `{{ code | replace("\n", "\\n") | replace("\t", "\\t") }}`;
  const initialCode = {{ code | tojson }};
  quill.setText(initialCode);

  // NUEVA FUNCIONALIDAD: Sincronizar scroll entre editor y n√∫meros de l√≠nea
  const editor = document.querySelector('#editor .ql-editor');
  const lineNumbers = document.querySelector('.line-numbers');
  
  function updateLineNumbers() {
    const text = quill.getText();
    const lines = text.split('\n');
    const lineCount = lines.length;
    
    let numbersHTML = '';
    for (let i = 1; i <= lineCount; i++) {
      numbersHTML += `<div class="line-number">${i}</div>`;
    }
    lineNumbers.innerHTML = numbersHTML;
  }
  
  // Funci√≥n para sincronizar scroll
  function syncScroll() {
    if (editor && lineNumbers) {
      lineNumbers.scrollTop = editor.scrollTop;
    }
  }
  
  updateLineNumbers();
  
  quill.on('text-change', function() {
    updateLineNumbers();
  });
  
  editor.addEventListener('scroll', syncScroll);
  
  window.addEventListener('resize', syncScroll);

  const form = document.getElementById('codeForm');
  form.addEventListener('submit', () => {
    document.getElementById('codeInput').value = quill.getText();
  });

  window.addEventListener('DOMContentLoaded', () => {
    const tokens = {{ tokens_json | tojson }};

    const colorMap = {
      1000: '#ab0ed6', // keyword
      2000: '#e36209', // operator
      3000: '#27c60b', // punctuation
      4000: '#005cc5', // curly-brace
      5000: '#079c29', // bracket
      6000: '#6f42c1', // identifier
      7000: '#005cc5', // integer
      8000: '#005cc5', // float
    };
    
    // Aplica formato a cada token
    tokens.forEach(t => {
      const color = colorMap[t.type];
      
      if (color && t.length > 0) {
        quill.formatText(t.index, t.length, { color });
      }
    });
  });

  const errors = {{ errors_json | tojson }};
  errors.forEach(e => {
    // subraya el error lex
    quill.formatText(e.index, e.length, {
      underline: true,
      color: '#ff0000'
    });
  });

  const errors_s = {{ errors_s_json | tojson }};
  errors_s.forEach(e => {
    // subraya el error semantico
    quill.formatText(e.index, e.length, {
      underline: true,
      color: '#ff0000'
    });
  });
</script>

</body>
</html>